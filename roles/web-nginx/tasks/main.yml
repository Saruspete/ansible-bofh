---

#
# Configure system
#

- block:
    - name: Package - Install EPEL
      package: name=epel-release state=present
    - name: Package - Install selinux-python
      package: name=libselinux-python state=present
  when: ansible_os_family == "RedHat"
  tags: ['package']

# Install packages
- name: Package - Install nginx
  package: name=nginx state=present
  tags: ['package']

# Fix user
#- name: Accounts - nginx
#  user: nginx


#
# Configure nginx
#

- name: Config - nginx.conf
  template: src={{ item }} dest=/etc/nginx/nginx.conf
  with_first_found:
    - files:
      - nginx.conf.{{ inventory_hostname }}.j2
      - nginx.conf.j2
    - paths:
      - ../templates
  notify: restart nginx
  tags: ['config']


#
# Crypto related
#
- name: Crypto - DH Param - Generate
  # https://security.stackexchange.com/questions/95178/diffie-hellman-parameters-still-calculating-after-24-hours
  command: openssl dhparam -dsaparam -out /etc/nginx/dhparam.pem 4096 creates=/etc/nginx/dhparam.pem
  tags: ['config','crypto']

- name: Crypto - DH Param - Fix perms
  file:
    path: /etc/nginx/dhparam.pem
    owner: "{{ http_data_user }}"
    group: "{{ http_data_group }}"
  tags: ['config','crypto']


#
# Folder structure
#

#- name: Folders - Create default virtalhost
#  file: path={{ http_data_dir }}/default state=directory
#  tags: ['folders']

- name: Folders - Find all virtualhosts
  find:
    paths: "{{ http_data_dir }}"
    file_type: directory
  register: vhosts
  tags: ['always']

# Create virtualhost structure
- name: Folders - Create hierarchy of virtualhost
  file:
    path: "{{ item.0.path }}/{{ item.1 }}"
    state: directory
    mode: 0750
    owner: "{{ http_data_user }}"
    group: "{{ http_data_group }}"
    unsafe_writes: yes
  with_nested:
    - "{{ vhosts.files }}"
    - [ 'bin', 
        'conf', 'conf/nginx',
        'cron', 
        'html', 'html/public', 
        'logs', 'logs/nginx',
        'priv',
        'temp', 'temp/temp', 'temp/nginx', 'temp/upload', 'temp/session' ]
  tags: ['folders']

#
# Manage https certificates
#

# Use letsencrypt free certs
- name: Crypto - Request Certificate
  include_role: name=pki-letsencrypt
  vars:
    letsencrypt_webroot_path: "{{ domain.path }}/html/public"
    letsencrypt_cert_domains: 
      - "{{ domain.path | webfolder2domain }}"
  with_items:
    "{{ vhosts.files }}"
  when: domain != "default"
  loop_control:
    loop_var: domain
  tags: ['crypto']

- name: Crypto - Create links to priv folder
  file:
    state: link
    src: "/etc/letsencrypt/live/{{ item.0.path | webfolder2domain }}/{{ item.1 }}"
    path: "{{ item.0.path }}/priv/{{ item.1 }}"
  with_nested:
    - "{{ vhosts.files }}"
    - [ 'cert.pem', 'chain.pem', 'fullchain.pem', 'privkey.pem' ]

# Check if certificates exists
- name: Crypto - Check if certificate exists
  stat: path={{ item.path }}/priv/privkey.pem
  with_items: "{{ vhosts.files }}"
  register: ssl_certificates
  tags: ['crypto']

- set_fact:
    domains_certificates: []
  tags: ['always']
- name: Ansible - Set list of valid certificates
  set_fact:
    domains_certificates: "{{ domains_certificates }} + [ '{{ item.item.path }}' ]"
  when:
    - item.stat.exists == true
  with_items: "{{ ssl_certificates.results }}"
  tags: ['always']

#
# Deploy configuration
#

- name: Config - nginx.sub.conf
  template: src=../templates/nginx.sub.conf.j2 dest={{ item.path }}/conf/nginx.conf
  with_items: "{{ vhosts.files }}"
  notify: restart nginx

- name: Config - nginx.sub.common.conf
  template: src=../templates/nginx.sub.common.conf.j2 dest={{ item.path }}/conf/nginx.common.conf
  with_items: "{{ vhosts.files }}"
  notify: restart nginx



#
# Services
#

- name: start the nginx service
  service: name=nginx state=started enabled=yes

